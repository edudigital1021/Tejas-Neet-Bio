import React, { useState, useEffect, useMemo } from 'react';
import { 
  ChevronLeft, ChevronRight, Play, RotateCcw, CheckCircle, XCircle, 
  Clock, BarChart3, BookOpen, Award, ArrowLeft, Moon, Sun, 
  AlertCircle, Eye, Filter, Search, User, History, LogOut, X 
} from 'lucide-react';
import {
  Chart as ChartJS, CategoryScale, LinearScale, BarElement, 
  Title, Tooltip, Legend, ArcElement, PointElement, LineElement,
} from 'chart.js';
import { Bar, Doughnut } from 'react-chartjs-2';

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from 'firebase/firestore';

ChartJS.register(CategoryScale, LinearScale, BarElement, Title, Tooltip, Legend, ArcElement, PointElement, LineElement);

// ==========================================
// 1. FIREBASE CONFIGURATION (INTEGRATED)
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyBYclFi9AIsR5HB6FvGbJCc2Ed6x3Nguv0",
  authDomain: "tejas-neet-bio.firebaseapp.com",
  projectId: "tejas-neet-bio",
  storageBucket: "tejas-neet-bio.firebasestorage.app",
  messagingSenderId: "359240762418",
  appId: "1:359240762418:web:4fe49fd69019605ea1682b"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Use a unique App ID for collection paths (Mandatory Rule 1)
const appId = typeof __app_id !== 'undefined' ? __app_id : 'tejas-neet-bio-pyq';

// ==========================================
// 2. CHAPTER CONFIGURATION
// ==========================================
const CHAPTER_DATA = {
  "11": [
    "The Living World", "Biological Classification", "Plant Kingdom", "Animal Kingdom",
    "Morphology of Flowering Plants", "Anatomy of Flowering Plants", "Structural Organisation in Animals",
    "Cell: The Unit of Life", "Biomolecules", "Cell Cycle and Cell Division",
    "Photosynthesis in Higher Plants", "Respiration in Plants", "Plant Growth and Development",
    "Breathing and Exchange of Gases", "Body Fluids and Circulation", "Excretory Products and their Elimination",
    "Locomotion and Movement", "Neural Control and Coordination", "Chemical Coordination and Integration"
  ],
  "12": [
    "Sexual Reproduction in Flowering Plants", "Human Reproduction", "Reproductive Health",
    "Principles of Inheritance and Variation", "Molecular Basis of Inheritance", "Evolution",
    "Human Health and Disease", "Microbes in Human Welfare", "Biotechnology: Principles and Processes",
    "Biotechnology and its Applications", "Organisms and Populations", "Ecosystem", "Biodiversity and Conservation"
  ]
};

// ==========================================
// 3. THE QUESTION DATABASE
// ==========================================
const RAW_QUESTIONS = [
  { 
    id: 1, 
    question: "Which of the following is responsible for peat formation?", 
    options: ["Marchantia", "Riccia", "Funaria", "Sphagnum"], 
    correctAnswer: 3, 
    year: 2014, 
    chapter: "Plant Kingdom", 
    classLevel: "11", 
    topic: "Bryophytes", 
    solution: "Sphagnum forms peat over time due to slow decomposition." 
  },
  { 
    id: 2, 
    question: "Select the wrong statement.", 
    options: ["Walls of diatoms are easily destructible", "Diatomaceous earth is formed by diatoms", "Diatoms are chief producers", "Diatoms float passively"], 
    correctAnswer: 0, 
    year: 2016, 
    chapter: "Biological Classification", 
    classLevel: "11", 
    topic: "Chrysophytes", 
    solution: "Diatom walls are indestructible due to silica." 
  },
  { 
    id: 3, 
    question: "The term 'Nuclein' for genetic material was used by:", 
    options: ["Mendel", "Friedrich Meischer", "Watson and Crick", "Franklin"], 
    correctAnswer: 1, 
    year: 2021, 
    chapter: "Molecular Basis of Inheritance", 
    classLevel: "12", 
    topic: "DNA", 
    solution: "Friedrich Miescher discovered nuclein in 1869." 
  }
];

const generateMockData = (count) => {
  const chapters = [...CHAPTER_DATA["11"], ...CHAPTER_DATA["12"]];
  return Array.from({ length: count }, (_, i) => ({
    id: 100 + i,
    question: `NEET Biology PYQ Question ${i + 4}: NCERT based conceptual question?`,
    options: ["Option A", "Option B", "Option C", "Option D"],
    correctAnswer: 0,
    year: 2010 + Math.floor(Math.random() * 16),
    chapter: chapters[Math.floor(Math.random() * chapters.length)],
    classLevel: Math.random() > 0.5 ? "11" : "12",
    topic: "Core Topic",
    solution: "NCERT Biology textbook ke according explanation yahan aayega."
  }));
};

const ALL_QUESTIONS = [...RAW_QUESTIONS, ...generateMockData(20)];
const ALL_CHAPTER_LIST = ["All Chapters", ...CHAPTER_DATA["11"], ...CHAPTER_DATA["12"]];
const YEAR_RANGE = Array.from({ length: 16 }, (_, i) => 2010 + i); // 2010 to 2025

export default function App() {
  const [user, setUser] = useState(null);
  const [history, setHistory] = useState([]);
  const [showProfile, setShowProfile] = useState(false);
  const [view, setView] = useState('home');
  const [darkMode, setDarkMode] = useState(true);
  const [reviewFilter, setReviewFilter] = useState('all'); 
  const [filters, setFilters] = useState({
    classLevel: "All",
    chapter: "All Chapters",
    startYear: 2010,
    endYear: 2025
  });

  const [session, setSession] = useState({
    questions: [],
    currentIndex: 0,
    userAnswers: {}, 
    startTime: null,
    totalTime: 0,
    isActive: false
  });

  // Auth Initialization (Mandatory Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Firebase Auth Error:", err);
      }
    };
    initAuth();
    return onAuthStateChanged(auth, setUser);
  }, []);

  // Sync History (Mandatory Rule 1 & 2)
  useEffect(() => {
    if (!user) return;
    const historyRef = collection(db, 'artifacts', appId, 'users', user.uid, 'history');
    // Fetch all then sort in memory as per Rule 2
    return onSnapshot(historyRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setHistory(data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));
    }, (err) => console.error("Firestore Error:", err));
  }, [user]);

  useEffect(() => {
    document.documentElement.classList.toggle('dark', darkMode);
  }, [darkMode]);

  const availableChapters = useMemo(() => {
    if (filters.classLevel === "All") return ALL_CHAPTER_LIST;
    return ["All Chapters", ...CHAPTER_DATA[filters.classLevel]];
  }, [filters.classLevel]);

  const startPractice = () => {
    const filtered = ALL_QUESTIONS.filter(q => {
      const classMatch = filters.classLevel === "All" || q.classLevel === filters.classLevel;
      const chapterMatch = filters.chapter === "All Chapters" || q.chapter === filters.chapter;
      const yearMatch = q.year >= filters.startYear && q.year <= filters.endYear;
      const isValid = q.question && q.options?.length === 4 && q.correctAnswer !== undefined;
      return classMatch && chapterMatch && yearMatch && isValid;
    });

    if (filtered.length === 0) return alert("No questions found! Expand your filters.");
    
    setSession({ 
      questions: filtered, 
      currentIndex: 0, 
      userAnswers: {}, 
      startTime: Date.now(), 
      totalTime: 0, 
      isActive: true 
    });
    setView('practice');
  };

  const finishPractice = async () => {
    const totalTime = Math.floor((Date.now() - session.startTime) / 1000);
    const attemptedKeys = Object.keys(session.userAnswers);
    const correctCount = Object.values(session.userAnswers).filter(a => a.isCorrect).length;
    const score = (correctCount * 4) - (attemptedKeys.length - correctCount);
    
    const stats = {
      score,
      totalQuestions: session.questions.length,
      accuracy: attemptedKeys.length > 0 ? Math.round((correctCount / attemptedKeys.length) * 100) : 0,
      timestamp: serverTimestamp(),
      chapter: filters.chapter,
      classLevel: filters.classLevel,
      totalTime
    };

    setSession(prev => ({ ...prev, isActive: false, totalTime }));
    setView('report');

    if (user) {
      try {
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'history'), stats);
      } catch (e) { console.error("Save history error:", e); }
    }
  };

  const handleAnswer = (questionId, optionIndex) => {
    if (session.userAnswers[questionId]) return;
    const question = session.questions[session.currentIndex];
    const isCorrect = optionIndex === question.correctAnswer;
    setSession(prev => ({
      ...prev,
      userAnswers: { ...prev.userAnswers, [questionId]: { selectedIndex: optionIndex, isCorrect } }
    }));
  };

  // --- UI COMPONENTS ---

  const ProfileModal = () => (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in">
      <div className="w-full max-w-lg bg-white dark:bg-slate-900 rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-800 flex flex-col max-h-[90vh]">
        <div className="p-6 border-b dark:border-slate-800 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center text-white"><User size={24} /></div>
            <div>
              <h2 className="text-xl font-black dark:text-white">Profile</h2>
              <p className="text-[10px] font-mono text-slate-400">UID: {user?.uid}</p>
            </div>
          </div>
          <button onClick={() => setShowProfile(false)}><X size={24} className="dark:text-white" /></button>
        </div>
        <div className="flex-1 overflow-y-auto p-6 space-y-4">
          <div className="grid grid-cols-2 gap-4">
             <div className="p-4 bg-indigo-50 dark:bg-indigo-900/20 rounded-2xl border dark:border-slate-800 text-center">
                <p className="text-[10px] font-black text-indigo-500 uppercase">Tests</p>
                <p className="text-2xl font-black dark:text-white">{history.length}</p>
             </div>
             <div className="p-4 bg-green-50 dark:bg-green-900/20 rounded-2xl border dark:border-slate-800 text-center">
                <p className="text-[10px] font-black text-green-500 uppercase">Best Score</p>
                <p className="text-2xl font-black dark:text-white">{history.length > 0 ? Math.max(...history.map(h => h.score || 0)) : 0}</p>
             </div>
          </div>
          <div className="space-y-2">
            {history.map((h, i) => (
              <div key={i} className="p-4 bg-slate-50 dark:bg-slate-800 rounded-2xl flex justify-between items-center border dark:border-slate-700">
                <div className="truncate pr-4">
                  <p className="text-xs font-bold dark:text-white truncate">{h.chapter}</p>
                  <p className="text-[10px] text-slate-400">{new Date(h.timestamp?.seconds * 1000).toLocaleDateString()}</p>
                </div>
                <div className="text-right">
                  <p className="font-black text-indigo-500">+{h.score}</p>
                  <p className="text-[9px] font-bold text-slate-400">{h.accuracy}% Accuracy</p>
                </div>
              </div>
            ))}
          </div>
        </div>
        <div className="p-6 border-t dark:border-slate-800">
           <button onClick={() => signOut(auth)} className="w-full py-3 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 rounded-xl">Sign Out</button>
        </div>
      </div>
    </div>
  );

  const HomeView = () => (
    <div className="flex flex-col items-center justify-center min-h-screen p-4 animate-in fade-in">
      <div className="fixed top-6 left-6 z-50">
        <button onClick={() => setShowProfile(true)} className="w-12 h-12 bg-white dark:bg-slate-900 rounded-2xl shadow-xl border dark:border-slate-800 text-indigo-500 flex items-center justify-center"><User size={24} /></button>
      </div>
      <div className="w-full max-w-md bg-white dark:bg-slate-900 rounded-[2.5rem] p-8 shadow-2xl border dark:border-slate-800">
        <div className="text-center mb-10">
          <div className="inline-flex p-4 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl mb-4 text-indigo-600"><BookOpen size={40} /></div>
          <h1 className="text-4xl font-black dark:text-white mb-2 tracking-tight">TEJAS <span className="text-indigo-500">BIO PYQ</span></h1>
          <p className="text-slate-400 font-bold uppercase tracking-widest text-[9px]">NCERT Mastery Engine</p>
        </div>
        <div className="space-y-6">
          <div>
            <label
            className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 px-1">Class Level</label>
            <div className="grid grid-cols-3 gap-2">
              {["All", "11", "12"].map(l => (
                <button key={l} onClick={() => setFilters({...filters, classLevel: l})} className={`h-11 rounded-xl font-bold transition-all border ${filters.classLevel === l ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-50 dark:bg-slate-800 dark:text-slate-400 border-slate-200 dark:border-slate-700'}`}>{l === "All" ? "Both" : `Class ${l}`}</button>
              ))}
            </div>
          </div>
          <div>
            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 px-1">Select Chapter</label>
            <select value={filters.chapter} onChange={e => setFilters({...filters, chapter: e.target.value})} className="w-full h-12 bg-slate-50 dark:bg-slate-800 rounded-xl px-4 font-bold dark:text-white border dark:border-slate-700 focus:ring-2 focus:ring-indigo-500 transition-all outline-none">
              {availableChapters.map(c => <option key={c} value={c}>{c}</option>)}
            </select>
          </div>
          <div className="grid grid-cols-2 gap-4">
             <div>
                <label className="text-[10px] font-black text-slate-400 uppercase block mb-2 px-1 tracking-widest">From Year</label>
                <select 
                  value={filters.startYear} 
                  onChange={e => setFilters({...filters, startYear: parseInt(e.target.value)})} 
                  className="w-full h-11 bg-slate-50 dark:bg-slate-800 rounded-xl px-4 font-bold dark:text-white border dark:border-slate-700 outline-none focus:ring-2 focus:ring-indigo-500"
                >
                  {YEAR_RANGE.map(y => <option key={y} value={y}>{y}</option>)}
                </select>
             </div>
             <div>
                <label className="text-[10px] font-black text-slate-400 uppercase block mb-2 px-1 tracking-widest">To Year</label>
                <select 
                  value={filters.endYear} 
                  onChange={e => setFilters({...filters, endYear: parseInt(e.target.value)})} 
                  className="w-full h-11 bg-slate-50 dark:bg-slate-800 rounded-xl px-4 font-bold dark:text-white border dark:border-slate-700 outline-none focus:ring-2 focus:ring-indigo-500"
                >
                  {YEAR_RANGE.map(y => <option key={y} value={y}>{y}</option>)}
                </select>
             </div>
          </div>
          <button onClick={startPractice} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black text-lg shadow-xl shadow-indigo-500/20 active:scale-95 transition-all mt-2">START PRACTICE</button>
        </div>
      </div>
    </div>
  );

  const PracticeView = () => {
    const q = session.questions[session.currentIndex];
    const userAns = session.userAnswers[q.id];
    const progress = ((session.currentIndex + 1) / session.questions.length) * 100;
    return (
      <div className="min-h-screen bg-slate-50 dark:bg-slate-950 flex flex-col animate-in slide-in-from-right">
        <div className="h-16 px-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b dark:border-slate-800 flex items-center justify-between sticky top-0 z-10">
          <button onClick={() => setView('home')} className="p-2"><ArrowLeft className="dark:text-white" /></button>
          <div className="text-center">
            <p className="text-[9px] font-black text-indigo-500 uppercase truncate max-w-[150px]">{q.chapter}</p>
            <p className="text-sm font-bold dark:text-white">Question {session.currentIndex + 1}/{session.questions.length}</p>
          </div>
          <button onClick={finishPractice} className="px-3 py-1 bg-red-500 text-white rounded-lg text-[10px] font-black uppercase tracking-widest">Finish</button>
        </div>
        <div className="w-full h-1 bg-slate-200 dark:bg-slate-800"><div className="h-full bg-indigo-500 transition-all duration-300" style={{ width: `${progress}%` }} /></div>
        <div className="flex-1 max-w-3xl mx-auto w-full p-4 pb-32">
          <div className="bg-white dark:bg-slate-900 rounded-[2.5rem] p-8 shadow-sm border dark:border-slate-800 mb-6 animate-in fade-in zoom-in-95">
            <span className="px-3 py-1 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 text-[10px] font-black rounded-full mb-4 inline-block">NEET {q.year}</span>
            <h2 className="text-xl font-bold dark:text-white leading-relaxed mb-8">{q.question}</h2>
            <div className="space-y-3">
              {q.options.map((opt, i) => {
                const isSelected = userAns?.selectedIndex === i;
                const isCorrect = i === q.correctAnswer;
                const showStatus = !!userAns;
                let style = "bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-400";
                if (showStatus) {
                  if (isCorrect) style = "bg-green-100 dark:bg-green-900/20 border-green-500 text-green-700 dark:text-green-400 ring-2 ring-green-500";
                  else if (isSelected) style = "bg-red-100 dark:bg-red-900/20 border-red-500 text-red-700 dark:text-red-400 ring-2 ring-red-500";
                }
                return (
                  <button key={i} disabled={showStatus} onClick={() => handleAnswer(q.id, i)} className={`w-full p-5 rounded-3xl flex items-center border transition-all text-left group ${style}`}>
                    <span className="w-8 h-8 rounded-full bg-black/5 dark:bg-white/5 flex items-center justify-center font-black mr-4 group-hover:bg-indigo-500 group-hover:text-white transition-colors">{String.fromCharCode(65 + i)}</span>
                    <span className="font-bold flex-1">{opt}</span>
                    {showStatus && isCorrect && <CheckCircle size={20} className="text-green-500 ml-2" />}
                  </button>
                );
              })}
            </div>
          </div>
          {userAns && <div className="p-6 bg-indigo-50 dark:bg-indigo-900/20 rounded-3xl border dark:border-indigo-800 text-sm animate-in slide-in-from-bottom">
            <p className="text-[10px] font-black text-indigo-500 uppercase mb-2">Explanation</p>
            <p className="dark:text-slate-300 leading-relaxed font-medium italic">{q.solution}</p>
          </div>}
        </div>
        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-t dark:border-slate-800 flex gap-4">
           <button disabled={session.currentIndex === 0} onClick={() => setSession(p => ({...p, currentIndex: p.currentIndex - 1}))} className="flex-1 py-4 bg-slate-100 dark:bg-slate-800 dark:text-white rounded-2xl font-black text-xs disabled:opacity-30">PREV</button>
           <button onClick={() => session.currentIndex < session.questions.length - 1 ? setSession(p => ({...p, currentIndex: p.currentIndex + 1})) : finishPractice()} className="flex-[2] py-4 bg-indigo-600 text-white rounded-2xl font-black text-xs shadow-lg shadow-indigo-500/20 active:scale-95 transition-transform">
             {session.currentIndex === session.questions.length - 1 ? "FINISH" : (userAns ? "NEXT" : "SKIP")}
           </button>
        </div>
      </div>
    );
  };

  const ReportView = () => {
    const att = Object.keys(session.userAnswers).length;
    const cor = Object.values(session.userAnswers).filter(a => a.isCorrect).length;
    const score = (cor * 4) - (att - cor);
    const acc = att > 0 ? Math.round((cor / att) * 100) : 0;
    return (
      <div className="min-h-screen bg-slate-50 dark:bg-slate-950 p-6 flex flex-col items-center animate-in zoom-in-95">
        <div className="w-full max-w-xl space-y-6">
          <div className="flex justify-between items-center"><h2 className="text-3xl font-black dark:text-white">Analysis</h2><button onClick={() => setView('home')} className="p-3 bg-white dark:bg-slate-900 rounded-2xl border dark:border-slate-800 dark:text-white hover:rotate-180 transition-transform duration-500"><RotateCcw size={20}/></button></div>
          <div className="bg-gradient-to-br from-indigo-600 to-violet-700 p-10 rounded-[3rem] text-white shadow-2xl text-center relative overflow-hidden">
            <div className="absolute top-0 right-0 p-8 opacity-10"><BarChart3 size={120} /></div>
            <p className="text-[10px] font-black uppercase opacity-70 tracking-widest">Final NEET Score</p>
            <h3 className="text-8xl font-black my-4 tabular-nums">{score}</h3>
            <div className="grid grid-cols-2 mt-8 pt-8 border-t border-white/20">
              <div><p className="text-[10px] font-black uppercase opacity-70">Accuracy</p><p className="text-3xl font-black">{acc}%</p></div>
              <div><p className="text-[10px] font-black uppercase opacity-70">Attempted</p><p className="text-3xl font-black">{att}</p></div>
            </div>
          </div>
          <button onClick={() => setView('review')} className="w-full py-5 bg-white dark:bg-slate-900 border dark:border-slate-800 rounded-2xl font-black dark:text-white shadow-xl flex items-center justify-center gap-3 hover:scale-105 transition-transform active:scale-95"><Eye size={22} /> REVIEW PORTAL</button>
        </div>
      </div>
    );
  };

  const ReviewView = () => {
    const list = session.questions.filter(q => {
      const ua = session.userAnswers[q.id];
      if (reviewFilter === 'correct') return ua?.isCorrect;
      if (reviewFilter === 'incorrect') return ua && !ua.isCorrect;
      if (reviewFilter === 'skipped') return !ua;
      return true;
    });
    return (
      <div className="min-h-screen bg-slate-50 dark:bg-slate-950 flex flex-col">
        <div className="h-16 px-4 bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b dark:border-slate-800 flex items-center gap-4 sticky top-0 z-20">
          <button onClick={() => setView('report')} className="p-2"><ChevronLeft size={28} className="dark:text-white" /></button>
          <h3 className="font-black dark:text-white uppercase tracking-widest text-sm">Review Portal</h3>
        </div>
        <div className="flex gap-2 p-3 bg-white dark:bg-slate-900 border-b dark:border-slate-800 overflow-x-auto no-scrollbar sticky top-16 z-10">
           {['all', 'correct', 'incorrect', 'skipped'].map(f => (
             <button key={f} onClick={() => setReviewFilter(f)} className={`px-5 h-10 rounded-full text-[10px] font-black uppercase flex-shrink-0 transition-all ${reviewFilter === f ? 'bg-indigo-600 text-white shadow-lg' : 'bg-slate-100 dark:bg-slate-800 text-slate-400 border dark:border-slate-700'}`}>{f}</button>
           ))}
        </div>
        <div className="flex-1 p-4 space-y-6 pb-20">
          {list.map((q, i) => {
            const ua = session.userAnswers[q.id];
            const isSkipped = !ua;
            return (
              <div key={i} className="bg-white dark:bg-slate-900 rounded-[2.5rem] border dark:border-slate-800 p-6 shadow-sm animate-in slide-in-from-bottom">
                <div className="flex justify-between items-center mb-6">
                  <span className="text-[10px] font-black text-indigo-500 uppercase tracking-widest">NEET {q.year}</span>
                  <span className={`px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest ${isSkipped ? 'bg-slate-100 text-slate-500' : ua.isCorrect ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                    {isSkipped ? 'Skipped' : ua.isCorrect ? 'Correct' : 'Incorrect'}
                  </span>
                </div>
                <p className="font-bold dark:text-white mb-8 text-lg leading-relaxed">{q.question}</p>
                <div className="space-y-3">
                  {q.options.map((o, idx) => {
                    const isCorrect = idx === q.correctAnswer;
                    const isUser = ua?.selectedIndex === idx;
                    let s = "bg-slate-50 dark:bg-slate-800 text-slate-400 border-transparent";
                    if (isCorrect) s = "bg-green-50 dark:bg-green-900/20 border-green-500 text-green-700 dark:text-green-400 border-2 ring-1 ring-green-500 shadow-sm";
                    else if (isUser && !isCorrect) s = "bg-red-50 dark:bg-red-900/20 border-red-500 text-red-700 dark:text-red-400 border-2 ring-1 ring-red-500 shadow-sm";
                    return (
                      <div key={idx} className={`p-5 rounded-3xl text-sm font-black border flex items-center gap-4 transition-all ${s}`}>
                        <span className="w-7 h-7 rounded-full bg-black/5 dark:bg-white/5 flex items-center justify-center text-[10px] font-black flex-shrink-0">{String.fromCharCode(65 + idx)}</span>
                        <span className="flex-1 font-bold">{o}</span>
                        {isCorrect && <CheckCircle size={18} className="text-green-500 flex-shrink-0" />}
                        {isUser && !isCorrect && <XCircle size={18} className="text-red-500 flex-shrink-0" />}
                      </div>
                    );
                  })}
                </div>
                <div className="mt-8 pt-6 border-t dark:border-slate-800">
                   <p className="text-[10px] font-black text-indigo-500 mb-2 uppercase tracking-widest">Master Explanation:</p>
                   <p className="text-sm font-medium text-slate-600 dark:text-slate-400 bg-slate-50 dark:bg-slate-800/50 p-5 rounded-2xl italic leading-relaxed">{q.solution}</p>
                </div>
              </div>
            );
          })}
        </div>
      </div>
    );
  };

  return (
    <div className={`min-h-screen transition-colors duration-300 font-sans selection:bg-indigo-200 ${darkMode ? 'dark bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
      {view === 'home' && (
        <div className="fixed top-6 right-6 z-50 animate-in slide-in-from-top duration-700">
          <button onClick={() => setDarkMode(!darkMode)} className="p-3 bg-white dark:bg-slate-900 rounded-2xl shadow-xl border dark:border-slate-800 hover:scale-110 active:scale-95 transition-all">
            {darkMode ? <Sun size={24} className="text-amber-400" /> : <Moon size={24} className="text-indigo-500" />}
          </button>
        </div>
      )}
      {showProfile && <ProfileModal />}
      {view === 'home' && <HomeView />}
      {view === 'practice' && <PracticeView />}
      {view === 'report' && <ReportView />}
      {view === 'review' && <ReviewView />}
    </div>
  );
}